<div class="event-detail-container">
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading event...</p>
    </div>
  } @else if (event()) {
    <!-- Header with back button -->
    <header class="detail-header" [style.background]="event()!.color">
      <button class="back-btn" (click)="goBack()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>
      <div class="header-content">
        <span class="category-badge" [style.background]="event()!.category?.color">
          {{ event()!.category?.name }}
        </span>
        <h1 class="event-title">{{ event()!.title }}</h1>
        <p class="event-subtitle">{{ event()!.subtitle }}</p>
      </div>
    </header>

    <!-- Event Info Section -->
    <section class="info-section">
      <div class="info-card">
        <div class="info-row">
          <div class="info-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
          </div>
          <div class="info-content">
            <span class="info-label">Location</span>
            <span class="info-value">{{ event()!.city?.name }}{{ event()!.neighborhood ? ', ' + event()!.neighborhood : '' }}</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
            </svg>
          </div>
          <div class="info-content">
            <span class="info-label">Date</span>
            <span class="info-value">{{ formatDate(event()!.event_date) }}</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
          </div>
          <div class="info-content">
            <span class="info-label">Time</span>
            <span class="info-value">{{ formatTime(event()!.event_time) }}</span>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-icon rating">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
          </div>
          <span class="stat-value">{{ (event()!.avg_rating || 0).toFixed(1) }}</span>
          <span class="stat-label">Rating</span>
        </div>
        <div class="stat-item">
          <div class="stat-icon reviews">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/>
            </svg>
          </div>
          <span class="stat-value">{{ event()!.review_count || 0 }}</span>
          <span class="stat-label">Reviews</span>
        </div>
        <div class="stat-item">
          <div class="stat-icon visitors">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
          </div>
          <span class="stat-value">{{ event()!.visitor_count || 0 }}</span>
          <span class="stat-label">Visitors</span>
        </div>
      </div>
    </section>

    <!-- Attendance Section -->
    <section class="attendance-section">
      <h2 class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
        Attendance
      </h2>
      
      <div class="attendance-card">
        <p class="attendance-question">Did you attend this event?</p>
        <div class="attendance-options">
          <button 
            class="attendance-btn" 
            [class.active]="wasPresent()"
            (click)="wasPresent.set(true)"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            <span>Yes, I was there!</span>
          </button>
          <button 
            class="attendance-btn" 
            [class.active]="!wasPresent()"
            (click)="wasPresent.set(false)"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
            <span>No, I didn't go</span>
          </button>
        </div>
        
        @if (!hasCheckedIn() && wasPresent()) {
          <button class="checkin-btn" (click)="checkIn()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
            Check In Now
          </button>
        }
        
        @if (hasCheckedIn()) {
          <div class="checkin-status">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            <span>You've checked in to this event</span>
          </div>
        }
      </div>
    </section>

    <!-- Rating Section -->
    <section class="rating-section">
      <h2 class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
        </svg>
        {{ isEditing() ? 'Update Your Rating' : 'Rate This Event' }}
      </h2>

      <div class="rating-card">
        @if (submitted()) {
          <div class="success-message">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <h3>Thank you!</h3>
            <p>Your rating has been {{ isEditing() ? 'updated' : 'submitted' }}</p>
          </div>
        } @else {
          <!-- Star Rating -->
          <div class="star-rating">
            <p class="rating-label">How would you rate this event?</p>
            <div class="stars-container">
              @for (star of [1, 2, 3, 4, 5]; track star) {
                <button 
                  class="star-btn" 
                  [class.active]="star <= displayRating()"
                  [class.hover]="star <= hoverRating() && hoverRating() > 0"
                  (click)="setRating(star)"
                  (mouseenter)="setHoverRating(star)"
                  (mouseleave)="clearHoverRating()"
                >
                  <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                  </svg>
                </button>
              }
            </div>
            @if (userRating() > 0) {
              <span class="rating-text">
                @switch (userRating()) {
                  @case (1) { Poor }
                  @case (2) { Fair }
                  @case (3) { Good }
                  @case (4) { Very Good }
                  @case (5) { Excellent! }
                }
              </span>
            }
          </div>

          <!-- Review Text -->
          <div class="review-section">
            <label class="review-label">Write a review (optional)</label>
            <textarea 
              class="review-input"
              placeholder="Share your experience at this event..."
              rows="4"
              [ngModel]="reviewText()"
              (ngModelChange)="reviewText.set($event)"
            ></textarea>
          </div>

          <!-- Submit Button -->
          <button 
            class="submit-btn"
            [disabled]="!canSubmit()"
            (click)="submitRating()"
          >
            @if (submitting()) {
              <span class="btn-spinner"></span>
              Submitting...
            } @else {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
              {{ isEditing() ? 'Update Rating' : 'Submit Rating' }}
            }
          </button>
        }
      </div>
    </section>
  } @else {
    <div class="error-state">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="currentColor">
        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
      </svg>
      <h2>Event not found</h2>
      <p>The event you're looking for doesn't exist or has been removed.</p>
      <button class="back-home-btn" (click)="goBack()">Go Back</button>
    </div>
  }
</div>


